edge(0,41).
edge(0,54).
edge(100,51).
edge(100,67).
edge(101,110).
edge(101,21).
edge(10,123).
edge(101,32).
edge(10,148).
edge(102,74).
edge(103,125).
edge(103,27).
edge(103,30).
edge(10,44).
edge(104,59).
edge(105,16).
edge(10,52).
edge(105,88).
edge(106,57).
edge(107,14).
edge(107,19).
edge(107,70).
edge(107,73).
edge(108,114).
edge(110,105).
edge(110,133).
edge(110,137).
edge(110,66).
edge(1,110).
edge(111,14).
edge(111,26).
edge(111,44).
edge(11,149).
edge(111,54).
edge(11,26).
edge(113,130).
edge(113,67).
edge(113,68).
edge(113,88).
edge(114,119).
edge(114,145).
edge(115,17).
edge(115,23).
edge(11,55).
edge(115,63).
edge(116,26).
edge(116,33).
edge(11,65).
edge(11,80).
edge(118,149).
edge(118,62).
edge(1,19).
edge(119,39).
edge(119,40).
edge(119,82).
edge(119,9).
edge(120,108).
edge(121,149).
edge(122,45).
edge(12,28).
edge(123,122).
edge(123,15).
edge(123,46).
edge(123,52).
edge(123,9).
edge(124,26).
edge(124,73).
edge(124,93).
edge(125,126).
edge(125,23).
edge(125,45).
edge(125,6).
edge(125,70).
edge(125,75).
edge(126,106).
edge(126,38).
edge(127,117).
edge(127,121).
edge(127,39).
edge(127,95).
edge(128,122).
edge(128,149).
edge(128,15).
edge(128,31).
edge(129,115).
edge(12,94).
edge(129,83).
edge(129,90).
edge(130,112).
edge(13,115).
edge(131,35).
edge(13,14).
edge(132,47).
edge(132,80).
edge(133,100).
edge(133,26).
edge(133,43).
edge(133,45).
edge(133,58).
edge(134,101).
input(0).
input(101).
input(108).
input(112).
input(117).
input(124).
input(128).
input(130).
input(134).
input(135).
input(140).
input(143).
input(146).
input(20).
input(25).
input(29).
input(32).
input(34).
input(46).
input(47).
input(49).
input(52).
input(55).
input(59).
input(64).
input(77).
input(82).
input(84).
input(87).
input(88).
input(9).
input(92).
input(93).
input(94).
input(96).
input(98).
input(99).
vertex(0).
vertex(1).
vertex(10).
vertex(11).
vertex(12).
vertex(13).
vertex(14).
vertex(15).
vertex(16).
vertex(17).
vertex(18).
vertex(19).
vertex(2).
vertex(20).
vertex(21).
vertex(22).
vertex(23).
vertex(24).
vertex(25).
vertex(26).
vertex(27).
vertex(28).
vertex(29).
vertex(3).
vertex(30).
vertex(31).
vertex(32).
vertex(33).
vertex(34).
vertex(35).
vertex(36).
vertex(37).
vertex(38).
vertex(39).
vertex(4).
vertex(40).
vertex(41).
vertex(42).
vertex(43).
vertex(44).
vertex(45).
vertex(46).
vertex(47).
vertex(48).
vertex(49).
vertex(5).
vertex(50).
vertex(51).
vertex(52).
vertex(53).
vertex(54).
vertex(55).
vertex(56).
vertex(57).
vertex(58).
vertex(59).
vertex(6).
vertex(60).
vertex(61).
vertex(62).
vertex(63).
vertex(64).
vertex(65).
vertex(66).
vertex(67).
vertex(68).
vertex(69).
vertex(7).
vertex(70).
vertex(71).
vertex(72).
vertex(73).
vertex(74).
vertex(75).
vertex(76).
vertex(77).
vertex(78).
vertex(79).
vertex(8).
vertex(80).
vertex(81).
vertex(82).
vertex(83).
vertex(84).
vertex(85).
vertex(86).
vertex(87).
vertex(88).
vertex(89).
vertex(9).
vertex(90).
vertex(91).
vertex(92).
vertex(93).
vertex(94).
vertex(95).
vertex(96).
vertex(97).
vertex(98).
vertex(99).
obs_elabel(0,41,p).
obs_elabel(0,54,p).
obs_elabel(10,44,m).
obs_elabel(10,52,m).
obs_elabel(11,26,m).
obs_elabel(11,55,p).
obs_elabel(11,65,m).
obs_elabel(11,80,m).
obs_elabel(1,19,m).
obs_elabel(12,28,m).
obs_elabel(12,94,m).
obs_elabel(13,14,p).
obs_elabel(13,66,p).
obs_elabel(14,53,m).
obs_elabel(14,82,p).
obs_elabel(14,98,p).
obs_elabel(15,66,p).
obs_elabel(16,55,p).
obs_elabel(16,71,p).
obs_elabel(16,80,p).
obs_elabel(16,85,p).
obs_elabel(17,69,m).
obs_elabel(18,12,p).
obs_elabel(18,8,m).
obs_elabel(1,9,p).
obs_elabel(19,35,p).
obs_elabel(19,66,p).
obs_elabel(20,35,p).
obs_elabel(20,53,p).
obs_elabel(20,93,m).
obs_elabel(2,138,m).
obs_elabel(22,78,p).
obs_elabel(22,80,p).
obs_elabel(22,8,m).
obs_elabel(23,94,p).
obs_elabel(24,4,m).
obs_elabel(24,63,m).
obs_elabel(24,7,m).
obs_elabel(25,16,m).
obs_elabel(25,3,p).
obs_elabel(25,49,m).
obs_elabel(26,11,m).
obs_elabel(26,76,p).
obs_elabel(26,88,p).
obs_elabel(2,69,p).
obs_elabel(27,14,m).
obs_elabel(27,41,m).
obs_elabel(27,50,p).
obs_elabel(27,60,p).
obs_elabel(27,72,p).
obs_elabel(28,12,p).
obs_elabel(28,7,m).
obs_elabel(2,98,p).
obs_elabel(30,3,m).
obs_elabel(30,49,m).
obs_elabel(33,74,m).
obs_elabel(34,49,m).
obs_elabel(34,64,p).
obs_elabel(35,5,p).
obs_elabel(36,15,m).
obs_elabel(36,22,p).
obs_elabel(3,70,p).
obs_elabel(37,62,m).
obs_elabel(3,81,p).
obs_elabel(38,11,m).
obs_elabel(38,32,m).
obs_elabel(38,41,m).
obs_elabel(38,70,p).
obs_elabel(39,18,p).
obs_elabel(40,6,m).
obs_elabel(40,90,p).
obs_elabel(41,3,p).
obs_elabel(41,36,p).
obs_elabel(41,66,p).
obs_elabel(41,73,p).
obs_elabel(43,69,m).
obs_elabel(43,88,m).
obs_elabel(43,97,m).
obs_elabel(44,81,p).
obs_elabel(45,13,p).
obs_elabel(4,67,p).
obs_elabel(48,23,p).
obs_elabel(48,55,m).
obs_elabel(50,118,m).
obs_elabel(50,32,p).
obs_elabel(50,45,p).
obs_elabel(50,6,m).
obs_elabel(51,103,p).
obs_elabel(5,130,m).
obs_elabel(5,144,m).
obs_elabel(5,145,m).
obs_elabel(5,148,p).
obs_elabel(51,54,p).
obs_elabel(5,16,p).
obs_elabel(53,86,p).
obs_elabel(54,127,p).
obs_elabel(54,14,p).
obs_elabel(54,68,m).
obs_elabel(56,10,p).
obs_elabel(56,97,p).
obs_elabel(57,18,p).
obs_elabel(57,3,m).
obs_elabel(57,63,p).
obs_elabel(58,147,p).
obs_elabel(58,16,p).
obs_elabel(59,127,m).
obs_elabel(59,24,m).
obs_elabel(59,36,m).
obs_elabel(59,58,p).
obs_elabel(60,1,m).
obs_elabel(60,119,m).
obs_elabel(60,140,m).
obs_elabel(60,59,p).
obs_elabel(60,67,m).
obs_elabel(6,132,m).
obs_elabel(61,33,p).
obs_elabel(6,2,m).
obs_elabel(62,110,p).
obs_elabel(62,137,p).
obs_elabel(62,14,p).
obs_elabel(62,63,p).
obs_elabel(63,69,m).
obs_elabel(64,73,m).
obs_elabel(64,85,p).
obs_elabel(65,142,p).
obs_elabel(65,73,p).
obs_elabel(65,81,p).
obs_elabel(65,94,m).
obs_elabel(66,117,m).
obs_elabel(66,6,p).
obs_elabel(67,13,p).
obs_elabel(67,32,p).
obs_elabel(68,14,p).
obs_elabel(68,16,p).
obs_elabel(68,83,m).
obs_elabel(6,9,p).
obs_elabel(69,145,m).
obs_elabel(69,31,p).
obs_elabel(69,92,m).
obs_elabel(70,39,p).
obs_elabel(70,51,m).
obs_elabel(70,73,m).
obs_elabel(70,88,m).
obs_elabel(71,107,p).
obs_elabel(71,30,m).
obs_elabel(71,44,m).
obs_elabel(72,109,p).
obs_elabel(72,110,p).
obs_elabel(72,59,p).
obs_elabel(73,107,p).
obs_elabel(73,17,m).
obs_elabel(73,89,p).
obs_elabel(74,122,p).
obs_elabel(74,6,m).
obs_elabel(75,63,p).
obs_elabel(75,72,m).
obs_elabel(76,75,p).
obs_elabel(7,71,m).
obs_elabel(77,145,p).
obs_elabel(77,3,p).
obs_elabel(77,69,m).
obs_elabel(77,8,m).
obs_elabel(78,112,m).
obs_elabel(78,113,m).
obs_elabel(78,115,p).
obs_elabel(78,98,m).
obs_elabel(79,76,p).
obs_elabel(80,85,m).
obs_elabel(81,16,p).
obs_elabel(81,37,m).
obs_elabel(81,6,m).
obs_elabel(81,79,m).
obs_elabel(8,18,m).
obs_elabel(81,86,p).
obs_elabel(83,130,p).
obs_elabel(83,43,m).
obs_elabel(84,118,m).
obs_elabel(84,119,p).
obs_elabel(84,138,p).
obs_elabel(8,56,p).
obs_elabel(85,67,m).
obs_elabel(86,21,m).
obs_elabel(86,24,p).
obs_elabel(87,108,m).
obs_elabel(87,12,m).
obs_elabel(87,36,p).
obs_elabel(87,82,m).
obs_elabel(87,83,p).
obs_elabel(88,32,p).
obs_elabel(88,46,p).
obs_elabel(88,99,m).
obs_elabel(89,144,m).
obs_elabel(89,8,p).
obs_elabel(90,18,p).
obs_elabel(90,23,p).
obs_elabel(91,127,m).
obs_elabel(91,74,p).
obs_elabel(93,140,p).
obs_elabel(94,121,p).
obs_elabel(94,129,m).
obs_elabel(95,60,p).
obs_elabel(95,67,m).
obs_elabel(96,102,p).
obs_elabel(96,31,m).
obs_elabel(97,109,p).
obs_elabel(97,116,p).
obs_elabel(97,56,p).
obs_elabel(97,63,p).
obs_elabel(98,112,m).
obs_vlabel(104,m).
obs_vlabel(108,p).
obs_vlabel(109,p).
obs_vlabel(111,m).
obs_vlabel(120,m).
obs_vlabel(18,m).
obs_vlabel(20,m).
obs_vlabel(21,p).
obs_vlabel(23,p).
obs_vlabel(36,p).
obs_vlabel(60,m).
obs_vlabel(65,p).
obs_vlabel(66,m).
obs_vlabel(85,m).
obs_vlabel(91,p).

%%%%%%%%%%%%%%%%%
% Preprocessing %
%%%%%%%%%%%%%%%%%

sign(m). sign(p).

diff(V,V)  :- edge(V,V), obs_elabel(V,V,m), not obs_elabel(V,V, p).
diff(U,V)  :- edge(U,V), obs_elabel(U,V,m), not obs_elabel(U,V, p), obs_vlabel(U,S), obs_vlabel(V,S).
diff(U,V)  :- edge(U,V), obs_elabel(U,V, p), not obs_elabel(U,V,m), obs_vlabel(U,S), obs_vlabel(V,T), S != T.

nontriv(V) :- vertex(V), not input(V), edge(U,V), not diff(U,V).
trivial(V) :- vertex(V), not input(V), not nontriv(V).

btedge(W,U,V) :- vertex(V), not input(V), not trivial(V), edge(W,V), edge(U,V), edge(Z,V), W < Z, Z < U.
ntedge(W,U,V) :- vertex(V), not input(V), not trivial(V), edge(W,V), edge(U,V), W < U, not btedge(W,U,V).
nfirst(U,V)   :- ntedge(W,U,V).
nlast(W,V)    :- ntedge(W,U,V).
first(U,V)    :- vertex(V), not input(V), not trivial(V), edge(U,V), not nfirst(U,V).
last(U,V)     :- vertex(V), not input(V), not trivial(V), edge(U,V), not nlast(U,V).


%%%%%%%%%%%%%
% Generator %
%%%%%%%%%%%%%

active(V) | inactive(V) :- vertex(V), not input(V).
inactive(V)             :- vertex(V), not input(V), active(W), trivial(W), V != W.
singleton               :- active(V), trivial(V).

reach(U,V) :- edge(U,V), active(V), not trivial(V).
reach(V,U) :- edge(U,V), active(V), not trivial(V),                        not obs_vlabel(U,p), not obs_vlabel(U,m).
reach(U,W) :- edge(U,V), active(V), not trivial(V), reach(V,W), vertex(W).
reach(V,W) :- edge(U,V), active(V), not trivial(V), reach(U,W), vertex(W), not obs_vlabel(U,p), not obs_vlabel(U,m).

aedge(V) :- vertex(V), not input(V), not trivial(V), not obs_vlabel(V,p), not obs_vlabel(V,m), active(W), edge(V,W).

:- active(V), not trivial(V), active(W), not trivial(W), not reach(V,W).
:- active(V), not trivial(V), not obs_vlabel(V,p), not obs_vlabel(V,m), not aedge(V).


%%%%%%%%%%%%%%%%%%%%%%
% Inconsistency Test %
%%%%%%%%%%%%%%%%%%%%%%

vlabel(V,p)   | vlabel(V,m)   :- active(V),    not trivial(V),               not obs_vlabel(V,p),   not obs_vlabel(V,m).
vlabel(U,p)   | vlabel(U,m)   :- active(V),    not trivial(V), edge(U,V),    not obs_vlabel(U,p),   not obs_vlabel(U,m).
llabel(U,V,p) | llabel(U,V,m) :- active(V),    not trivial(V), edge(U,V),    not obs_elabel(U,V,p), not obs_elabel(U,V,m).

vlabel(V,S)   :- vertex(V), obs_vlabel(V,S),   not trivial(V), not input(V).
vlabel(U,S)   :- edge(U,V), obs_vlabel(U,S),   not trivial(V), not input(V).
llabel(U,V,S) :- edge(U,V), obs_elabel(U,V,S), not trivial(V), not input(V).

oppo(U,V)     :- llabel(U,V,m), vlabel(U,S),   not trivial(V), not input(V), not obs_elabel(U,V,p), active(V), vlabel(V,S).
oppo(U,V)     :- llabel(U,V,p), vlabel(U,S),   not trivial(V), not input(V), not obs_elabel(U,V,m), active(V), vlabel(V,T), S != T.

coppo(U,V)    :- oppo(U,V), first(U,V).
coppo(U,V)    :- oppo(U,V), coppo(W,V), ntedge(W,U,V).

bot           :- singleton.
bot           :- active(V), coppo(U,V), last(U,V).

vlabel(V,S)   :- bot, vertex(V), sign(S),      not trivial(V), not input(V), not obs_vlabel(V,p),   not obs_vlabel(V,m).
vlabel(U,S)   :- bot, edge(U,V), sign(S),      not trivial(V), not input(V), not obs_vlabel(U,p),   not obs_vlabel(U,m).
llabel(U,V,S) :- bot, edge(U,V), sign(S),      not trivial(V), not input(V), not obs_elabel(U,V,p), not obs_elabel(U,V,m).

:- not bot.


%%%%%%%%%%%%%%%%%%%
% Minimality Test %
%%%%%%%%%%%%%%%%%%%

mvlabel(W,V,p)   | mvlabel(W,V,m)   :-                active(W), not trivial(V), not trivial(W), active(V), reach(V,W), reach(W,V), W != V.
mvlabel(W,U,p)   | mvlabel(W,U,m)   :- edge(U,V),     active(W), not trivial(V), not trivial(W), active(V), reach(V,W), reach(W,V), W != V.
mllabel(W,U,V,p) | mllabel(W,U,V,m) :- edge(U,V),     active(W), not trivial(V), not trivial(W), active(V), reach(V,W), reach(W,V), W != V.

mvlabel(W,V,S)   :- obs_vlabel(V,S),                  vertex(W), not trivial(V), not trivial(W), not input(V), not input(W),        W != V.
mvlabel(W,U,S)   :- obs_vlabel(U,S),    edge(U,V),    vertex(W), not trivial(V), not trivial(W), not input(V), not input(W),        W != V.
mllabel(W,U,V,S) :- obs_elabel(U,V,S),  edge(U,V),    vertex(W), not trivial(V), not trivial(W), not input(V), not input(W),        W != V.

minfl(W,V,p)     :- mvlabel(W,U,S), mllabel(W,U,V,S), active(W), not trivial(V), not trivial(W), active(V), reach(V,W), reach(W,V), W != V.
minfl(W,V,m)     :- mvlabel(W,U,S), mllabel(W,U,V,T), active(W), not trivial(V), not trivial(W), active(V), reach(V,W), reach(W,V), W != V, S != T.

:- active(V), active(W), not trivial(V), not trivial(W), W != V, mvlabel(W,V,S), not minfl(W,V,S).


%%%%%%%%%%
% Output %
%%%%%%%%%%

% #hide.
% #show active(V).
